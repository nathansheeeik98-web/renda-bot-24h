<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard - RendaBot 24h</title>
  <style>
    body{font-family:system-ui;margin:0;background:#0b1220;color:#e7eefc}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{background:#111b33;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;margin:12px 0}
    a{color:#a9c7ff;text-decoration:none}
    a:hover{text-decoration:underline}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;font-size:14px}
    .ok{color:#7CFFB2} .bad{color:#FF8B8B}
    .muted{opacity:.75}
    svg{width:100%;height:260px;display:block}
    .gridline{stroke:rgba(255,255,255,.08);stroke-width:1}
    .line{fill:none;stroke:rgba(169,199,255,.95);stroke-width:3}
    .dot{fill:rgba(169,199,255,.95)}
    button,select{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0b1220;color:#e7eefc}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="muted">üìä Dashboard</div>
      <h1 style="margin:6px 0 0">RendaBot 24h ‚Äî Crescimento di√°rio</h1>
      <div class="muted" style="margin-top:6px">
        <a href="/">Home</a> ‚Ä¢ <a href="/sitemap.xml">Sitemap</a> ‚Ä¢ <a href="/gerado/renda-1.html">P√°gina 1</a>
      </div>
    </div>

    <div class="card">
      <div class="muted">KPIs</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <div>üìÑ Total: <b id="kTotal">‚Äî</b></div>
        <div>‚ûï Hoje: <b id="kHoje">‚Äî</b></div>
        <div>‚è±Ô∏è Tempo: <b id="kTempo">‚Äî</b></div>
        <div>‚òÅÔ∏è Push: <b id="kPush">‚Äî</b></div>
      </div>
      <div class="muted" style="margin-top:10px">√öltima atualiza√ß√£o: <span id="kUp">‚Äî</span></div>
    </div>

    <div class="card">
      <div class="muted">Gr√°fico (Total acumulado)</div>
      <div style="margin-top:10px">
        <select id="period">
          <option value="14">14 dias</option>
          <option value="30" selected>30 dias</option>
          <option value="90">90 dias</option>
          <option value="365">365 dias</option>
        </select>
        <button id="reload">Recarregar</button>
      </div>
      <div style="margin-top:10px">
        <svg viewBox="0 0 1000 260" preserveAspectRatio="none" id="chart"></svg>
      </div>
      <div class="muted" id="hint" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <div class="muted">Hist√≥rico</div>
      <div style="overflow:auto;margin-top:10px">
        <table>
          <thead><tr><th>Data</th><th>Gerado</th><th>Total</th><th>Tempo</th><th>Push</th></tr></thead>
          <tbody id="tb"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
async function load(){
  const period = Number(document.getElementById("period").value);
  const data = await fetch("/stats.json?v="+Date.now()).then(r=>r.json());
  const days = (data.days||[]).slice().sort((a,b)=>(a.date||"").localeCompare(b.date||""));
  const slice = days.slice(-period);
  const last = slice[slice.length-1] || null;

  document.getElementById("kTotal").textContent = last ? (last.total ?? "‚Äî") : "‚Äî";
  document.getElementById("kHoje").textContent  = last ? (last.generated ?? "‚Äî") : "‚Äî";
  document.getElementById("kTempo").textContent = last ? ((last.durationSec ?? "‚Äî")+"s") : "‚Äî";
  document.getElementById("kPush").innerHTML    = last ? (last.pushOk ? "<span class='ok'>OK</span>" : "<span class='bad'>Falhou</span>") : "‚Äî";
  document.getElementById("kUp").textContent    = data?.meta?.updatedAt ?? "‚Äî";

  const tb = document.getElementById("tb");
  tb.innerHTML = "";
  slice.slice().reverse().forEach(d=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.date||""}</td>
      <td>+${d.generated ?? ""}</td>
      <td>${d.total ?? ""}</td>
      <td>${(d.durationSec ?? "")}s</td>
      <td>${d.pushOk ? "<span class='ok'>OK</span>" : "<span class='bad'>Falhou</span>"}</td>
    `;
    tb.appendChild(tr);
  });

  drawChart(slice.map(x=>({y:Number(x.total||0)})));
}

function drawChart(points){
  const svg = document.getElementById("chart");
  svg.innerHTML = "";
  if(!points.length){ document.getElementById("hint").textContent="Sem dados ainda."; return; }

  const W=1000,H=260,padL=40,padR=20,padT=20,padB=30;
  const innerW=W-padL-padR, innerH=H-padT-padB;

  const ys=points.map(p=>p.y), minY=Math.min(...ys), maxY=Math.max(...ys);
  const spanY=Math.max(1,maxY-minY), n=points.length;

  for(let i=0;i<=4;i++){
    const y=padT+(innerH*i/4);
    const line=document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1",padL); line.setAttribute("x2",W-padR);
    line.setAttribute("y1",y); line.setAttribute("y2",y);
    line.setAttribute("class","gridline");
    svg.appendChild(line);
  }

  const path=document.createElementNS("http://www.w3.org/2000/svg","path");
  let d="";
  for(let i=0;i<n;i++){
    const x=padL+(innerW*(n===1?0:i/(n-1)));
    const y=padT+innerH-(innerH*((points[i].y-minY)/spanY));
    d += (i===0?"M":"L")+x.toFixed(2)+" "+y.toFixed(2)+" ";
  }
  path.setAttribute("d",d.trim()); path.setAttribute("class","line");
  svg.appendChild(path);

  for(let i=0;i<n;i++){
    const x=padL+(innerW*(n===1?0:i/(n-1)));
    const y=padT+innerH-(innerH*((points[i].y-minY)/spanY));
    const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx",x); c.setAttribute("cy",y); c.setAttribute("r",4);
    c.setAttribute("class","dot");
    svg.appendChild(c);
  }

  document.getElementById("hint").textContent =
    `Mostrando ${n} dias ‚Ä¢ Total ${points[n-1].y} ‚Ä¢ Min ${minY} ‚Ä¢ Max ${maxY}`;
}

document.getElementById("reload").onclick = load;
document.getElementById("period").onchange = load;
load();
</script>
</body>
</html>
